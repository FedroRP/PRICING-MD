<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Calculator - Worldwhite Enterprise</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- CONFIGURATION ---
        // URL Google Apps Script Anda
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz20x9-UZbamv9t0vmpaKnjrk0tkalFXmp15V-ny4Ojlrb1NGZJaad3bH05tW_wf_QZUw/exec"; 

        // --- ICON COMPONENTS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Tag: (props) => <IconWrapper {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></IconWrapper>,
            Lightbulb: (props) => <IconWrapper {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-3-2.5-5-5-5s-5 2-5 5c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Edit: (props) => <IconWrapper {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconWrapper>,
            Download: (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>,
            RefreshCw: (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            List: (props) => <IconWrapper {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>,
            Sheet: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="9" y2="21"/></IconWrapper>,
            Cloud: (props) => <IconWrapper {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5V5"/></IconWrapper>,
            AlertTriangle: (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconWrapper>
        };

        // --- DATA & CONFIGURATION ---
        const BRAND_TARGETS = {
            "HEYMALE": 57,
            "HEYLOCAL": 42,
            "BOONABOO": 44,
            "SHUWA": 42
        };

        // DB 1: WOMEN'S FASHION
        const GENERAL_COMPETITOR_DB = {
            "SCARFS": [
                { brand: "Buttonscarves", price: 425000 },
                { brand: "Nada Puspita", price: 335000 },
                { brand: "Kami Idea", price: 350000 },
                { brand: "Heaven Light", price: 175000 }
            ],
            "BAGS": [
                { brand: "Buttonscarves", price: 1800000 },
                { brand: "Kami Idea", price: 950000 },
                { brand: "Wearing Klamby", price: 850000 },
                { brand: "Nada Puspita", price: 799000 }
            ],
            "PRAYER SETS": [
                { brand: "Buttonscarves", price: 1500000 },
                { brand: "Nada Puspita", price: 975000 },
                { brand: "Wearing Klamby", price: 1200000 },
                { brand: "Heaven Light", price: 650000 }
            ],
            "PARFUME": [
                { brand: "Buttonscarves", price: 595000 },
                { brand: "Wearing Klamby", price: 450000 },
                { brand: "Heaven Light", price: 225000 },
                { brand: "Heavenscent", price: 199000 }
            ],
            "SHOES": [
                { brand: "Buttonscarves", price: 1975000 },
                { brand: "Wearing Klamby", price: 950000 },
                { brand: "Kami Idea", price: 1100000 },
                { brand: "Nada Puspita", price: 899000 }
            ],
            "APPARELS": [
                { brand: "Wearing Klamby", price: 650000 },
                { brand: "Kami Idea", price: 750000 },
                { brand: "Heaven Light", price: 399000 },
                { brand: "Nada Puspita", price: 475000 }
            ],
            "ACCESSORIES": [
                { brand: "Buttonscarves", price: 475000 },
                { brand: "Nada Puspita", price: 199000 },
                { brand: "Wearing Klamby", price: 250000 },
                { brand: "Kami Idea", price: 225000 }
            ],
            "SPORT SERIES": [
                { brand: "Buttonscarves", price: 475000 },
                { brand: "Wearing Klamby", price: 295000 },
                { brand: "Heaven Light", price: 150000 },
                { brand: "Nada Puspita", price: 225000 }
            ],
            "HOME WEAR": [
                { brand: "Wearing Klamby", price: 350000 },
                { brand: "Heaven Light", price: 199000 },
                { brand: "Nada Puspita", price: 299000 },
                { brand: "Buttonscarves", price: 975000 }
            ],
            "INNER WEAR": [
                { brand: "Buttonscarves", price: 125000 },
                { brand: "Nada Puspita", price: 85000 },
                { brand: "Heaven Light", price: 55000 },
                { brand: "Kami Idea", price: 75000 }
            ]
        };

        // DB 2: MEN'S FASHION
        const HEYMALE_COMPETITOR_DB = {
            "ACCESSORIES": [
                { brand: "Eiger", price: 149000 },
                { brand: "Kalibre", price: 199000 },
                { brand: "Bodypack", price: 125000 },
                { brand: "Roughneck 1991", price: 89000 }
            ],
            "JACKETS": [
                { brand: "Erigo", price: 350000 },
                { brand: "Roughneck 1991", price: 299000 },
                { brand: "Maternal Disaster", price: 420000 },
                { brand: "Sch.", price: 450000 }
            ],
            "KNITWEAR": [
                { brand: "Uniqlo", price: 399000 },
                { brand: "H&M", price: 349000 },
                { brand: "Gomuda", price: 249000 },
                { brand: "Local Knit", price: 199000 }
            ],
            "PANTS": [
                { brand: "Smith Berlin", price: 289000 },
                { brand: "Erigo", price: 185000 },
                { brand: "House of Smith", price: 320000 },
                { brand: "Livehaf", price: 199000 }
            ],
            "PERFUMES": [
                { brand: "Kahf", price: 75000 },
                { brand: "HMNS", price: 320000 },
                { brand: "Onix", price: 189000 },
                { brand: "Saff & Co", price: 249000 }
            ],
            "POLO SHIRTS": [
                { brand: "Crocodile (Local)", price: 250000 },
                { brand: "M231", price: 149000 },
                { brand: "Platini", price: 120000 },
                { brand: "Uniqlo", price: 299000 }
            ],
            "SHIRTS": [
                { brand: "M231", price: 189000 },
                { brand: "Alisan", price: 160000 },
                { brand: "Platini", price: 150000 },
                { brand: "Fargo", price: 175000 }
            ],
            "TEES": [
                { brand: "Aerostreet", price: 79000 },
                { brand: "Erigo", price: 99000 },
                { brand: "Maternal", price: 165000 },
                { brand: "Roughneck", price: 88000 }
            ]
        };

        // --- HELPER FUNCTIONS ---
        const formatRupiah = (val) => {
            const number = parseFloat(val);
            if (val === null || val === undefined || isNaN(number)) return "Rp0";
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(number);
        };

        const downloadTableAsCSV = (data, filename) => {
            const csvRows = [];
            const headers = Object.keys(data[0]);
            csvRows.push(headers.join(','));

            for (const row of data) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            // Pricing States
            const [pricingList, setPricingList] = useState([]);
            const [editingPricingId, setEditingPricingId] = useState(null); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            
            // Sync States
            const [isSaving, setIsSaving] = useState(false);
            const [notification, setNotification] = useState(null);
            
            // Delete Confirmation State (New)
            const [deleteConfirmation, setDeleteConfirmation] = useState(null);

            // Initial Form State
            const initialFormState = { 
                brand: 'HEYLOCAL', 
                targetGm: 42, 
                category: '', 
                articleName: '', 
                rspWeb: '', 
                hpp: '', 
                competitorPrice: '', 
                platformFee: 17.5, 
                marketingFee: 15, 
                otherFee: 0, 
                notes: '', 
                manualPrice: '' 
            };
            const [pricingForm, setPricingForm] = useState(initialFormState);

            // Determine active Competitor DB based on selected Brand
            const activeCompetitorDB = pricingForm.brand === 'HEYMALE' ? HEYMALE_COMPETITOR_DB : GENERAL_COMPETITOR_DB;

            // Load Data from LocalStorage
            useEffect(() => {
                const savedPricing = localStorage.getItem('planner_pricing_v3'); 
                if (savedPricing) setPricingList(JSON.parse(savedPricing));
                setIsDataLoaded(true);
            }, []);

            // Save Data to LocalStorage
            useEffect(() => { 
                if (isDataLoaded) localStorage.setItem('planner_pricing_v3', JSON.stringify(pricingList)); 
            }, [pricingList, isDataLoaded]);

            // Clear notification after 3s
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            // --- SPECIAL LOGIC FOR HEYMALE RSP CALCULATION ---
            const calculateHeymaleRspWeb = (hpp, targetGm) => {
                const h = parseFloat(hpp);
                const gm = parseFloat(targetGm) / 100;
                
                if (isNaN(h) || h <= 0 || isNaN(gm) || gm >= 1) return '';
                const rawRsp = h / (1 - gm);
                const roundedRsp = Math.ceil(rawRsp / 10000) * 10000 - 1000;
                return roundedRsp;
            };

            // --- PRICING LOGIC ENGINE ---
            const pricingResult = useMemo(() => {
                const { rspWeb, hpp, platformFee, marketingFee, otherFee, competitorPrice, brand, manualPrice, targetGm } = pricingForm;
                
                const safeParse = (val) => {
                    const parsed = parseFloat(val);
                    return isNaN(parsed) ? 0 : parsed;
                };

                const rWeb = safeParse(rspWeb); 
                const rHpp = safeParse(hpp); 
                const cPrice = safeParse(competitorPrice);
                const target = safeParse(targetGm) || BRAND_TARGETS[brand] || 0;
                
                const applyCharmPricing = (val) => {
                    if (val <= 0) return 0;
                    let rounded = Math.ceil(val / 10000) * 10000;
                    return rounded - 1000; 
                };

                const totalFeePct = safeParse(platformFee) + safeParse(marketingFee) + safeParse(otherFee);
                const totalFeeDecimal = totalFeePct / 100;
                
                let rspMpRaw = (1 - totalFeeDecimal) > 0.01 ? rWeb / (1 - totalFeeDecimal) : 0;
                let rspBaru = applyCharmPricing(rspMpRaw); 
                const feeNominalBaru = Math.round(rspBaru * totalFeeDecimal);

                let recommendation = { price: 0, reason: "", gmPct: 0, gmAbs: 0, maxDiscount: 0, status: 'neutral' };

                const marginDecimal = target / 100;
                const floorPriceRaw = (1 - totalFeeDecimal - marginDecimal) > 0 ? rHpp / (1 - totalFeeDecimal - marginDecimal) : rHpp;
                let floorPrice = applyCharmPricing(floorPriceRaw);
                if (floorPrice < floorPriceRaw) floorPrice += 10000;

                if (cPrice > 0) {
                    if (cPrice > floorPrice) {
                        const gap = 10000; 
                        let targetPrice = cPrice - gap;
                        targetPrice = applyCharmPricing(targetPrice);
                        if (targetPrice < floorPrice) targetPrice = floorPrice;

                        recommendation.price = targetPrice;
                        recommendation.status = 'good';
                        const feeRec = targetPrice * totalFeeDecimal;
                        recommendation.gmAbs = targetPrice - feeRec - rHpp;
                        recommendation.gmPct = targetPrice > 0 ? (recommendation.gmAbs / targetPrice) * 100 : 0;
                        recommendation.reason = `Harga kompetitor Rp${formatRupiah(cPrice)} cukup tinggi. \nSistem menyarankan **Rp${formatRupiah(targetPrice)}** (Undercut strategy). \nAnda menang harga (lebih murah Rp${formatRupiah(cPrice-targetPrice)}) tapi margin tetap tebal (${recommendation.gmPct.toFixed(1)}%).`;
                    } else {
                        recommendation.price = floorPrice;
                        recommendation.status = 'warning';
                        const feeRec = floorPrice * totalFeeDecimal;
                        recommendation.gmAbs = floorPrice - feeRec - rHpp;
                        recommendation.gmPct = floorPrice > 0 ? (recommendation.gmAbs / floorPrice) * 100 : 0;
                        recommendation.reason = `Harga kompetitor Rp${formatRupiah(cPrice)} terlalu rendah (di bawah target margin ${target}%). \nSaran sistem: **Rp${formatRupiah(floorPrice)}** (Batas bawah aman). \nJangan ikuti perang harga di bawah ini agar profit terjaga.`;
                    }
                } else {
                    recommendation.price = rspBaru;
                    recommendation.status = 'neutral';
                    const feeRec = rspBaru * totalFeeDecimal;
                    recommendation.gmAbs = rspBaru - feeRec - rHpp;
                    recommendation.gmPct = rspBaru > 0 ? (recommendation.gmAbs / rspBaru) * 100 : 0;
                    recommendation.reason = "Belum ada data kompetitor. Menggunakan harga ideal berbasis RSP Web.";
                }

                // Initial maxDiscount calculation (based on recommendation) - will be overridden for Manual Price below
                if (recommendation.price > 0) {
                    recommendation.maxDiscount = ((recommendation.price - rWeb) / recommendation.price) * 100;
                } else {
                    recommendation.maxDiscount = 0;
                }

                const rspMpSuggest = safeParse(manualPrice) || rspBaru; 
                const feeNominalSuggest = rspMpSuggest * totalFeeDecimal; 
                const gmAbsMp = rspMpSuggest - feeNominalSuggest - rHpp;
                const gmPctMp = rspMpSuggest > 0 ? (gmAbsMp / rspMpSuggest) * 100 : 0;
                const naikAbsolute = rspMpSuggest - rWeb;
                const gmAbsBaru = rspBaru - feeNominalBaru - rHpp;
                const gmPctBaru = rspBaru > 0 ? (gmAbsBaru / rspBaru) * 100 : 0;
                const webGmAbs = rWeb - rHpp;
                const webGmPct = rWeb > 0 ? (webGmAbs / rWeb) * 100 : 0;

                // --- NEW LOGIC FOR MAX DISCOUNT ---
                let maxDiscountSafe = 0;
                if (rspMpSuggest > 0) {
                    maxDiscountSafe = ((rspMpSuggest - rWeb) / rspMpSuggest) * 100;
                }
                
                // Profit at Max Disc (from previous request) = RSP WEB - Biaya Tambahan Baru - HPP
                let profitAtFloor = rWeb - feeNominalBaru - rHpp;

                return { 
                    webGmPct, webGmAbs, rspBaru, feeNominalBaru, gmPctBaru, recommendation, 
                    rspMpSuggest, gmAbsMp, gmPctMp, naikAbsolute, brandTarget: target, 
                    maxDiscountSafe, profitAtFloor, finalPrice: rspMpSuggest 
                };
            }, [pricingForm]);

            // --- EVENT HANDLERS ---
            
            const handleBrandChange = (e) => {
                const newBrand = e.target.value;
                const defaultGm = BRAND_TARGETS[newBrand] || 0;
                setPricingForm(prev => {
                    const newState = { ...prev, brand: newBrand, targetGm: defaultGm, category: '', competitorPrice: '', notes: '' };
                    if (newBrand === 'HEYMALE' && prev.hpp) newState.rspWeb = calculateHeymaleRspWeb(prev.hpp, defaultGm);
                    return newState;
                });
            };

            const handleHppChange = (e) => {
                const newHpp = e.target.value;
                setPricingForm(prev => {
                    const newState = { ...prev, hpp: newHpp };
                    if (prev.brand === 'HEYMALE') newState.rspWeb = calculateHeymaleRspWeb(newHpp, prev.targetGm);
                    return newState;
                });
            };

            const handleTargetGmChange = (e) => {
                const newGm = e.target.value;
                setPricingForm(prev => {
                    const newState = { ...prev, targetGm: newGm };
                    if (prev.brand === 'HEYMALE') newState.rspWeb = calculateHeymaleRspWeb(prev.hpp, newGm);
                    return newState;
                });
            };

            const handleCategoryChange = (e) => {
                const selectedCat = e.target.value;
                const currentDB = pricingForm.brand === 'HEYMALE' ? HEYMALE_COMPETITOR_DB : GENERAL_COMPETITOR_DB;
                const compData = currentDB[selectedCat];
                let avgPrice = '';
                let notes = '';
                if (compData && compData.length > 0) {
                    const prices = compData.map(c => c.price);
                    const total = prices.reduce((sum, p) => sum + p, 0);
                    avgPrice = Math.round(total / prices.length);
                    notes = `Avg Marketplace Price based on ${compData.length} competitors`;
                }
                setPricingForm(prev => ({ ...prev, category: selectedCat, competitorPrice: avgPrice, notes: notes }));
            };

            const sendToGoogleSheet = async (payload) => {
                if (!GOOGLE_SCRIPT_URL) return;
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify(payload)
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving to sheet:", error);
                    return false;
                }
            };

            const handleSavePricing = async () => {
                if (!pricingForm.articleName) return;
                setIsSaving(true);

                const currentId = editingPricingId || Date.now();
                const newItem = { id: currentId, ...pricingForm, ...pricingResult, date: new Date().toISOString().split('T')[0] };

                // Formatter Helper
                const fmtNum = (n) => { const val = parseFloat(n); return isNaN(val) ? 0 : Math.round(val); };
                const fmtPct = (n) => { const val = parseFloat(n); return isNaN(val) ? "0%" : Math.floor(val) + "%"; };

                // Sheet Payload (Formatted)
                const sheetPayload = {
                    ...newItem,
                    rspWeb: fmtNum(newItem.rspWeb),
                    webGmAbs: fmtNum(newItem.webGmAbs),
                    hpp: fmtNum(newItem.hpp),
                    brandTarget: fmtPct(newItem.brandTarget),
                    rspMpSuggest: fmtNum(newItem.rspMpSuggest),
                    gmAbsMp: fmtNum(newItem.gmAbsMp),
                    gmPctMp: fmtPct(newItem.gmPctMp),
                    maxDiscountSafe: fmtPct(newItem.maxDiscountSafe),
                    profitAtFloor: fmtNum(newItem.profitAtFloor)
                };

                const requestPayload = { action: "upsert", ...sheetPayload };

                if (GOOGLE_SCRIPT_URL) {
                    try {
                        await sendToGoogleSheet(requestPayload);
                        setNotification({ type: 'success', message: 'Data synced to Google Sheets!' });
                    } catch (e) {
                        setNotification({ type: 'error', message: 'Failed to sync to Sheets.' });
                    }
                } else if(!editingPricingId) {
                     setNotification({ type: 'warning', message: 'Saved locally. Add Script URL to sync to Sheets.' });
                }

                if (editingPricingId) {
                    setPricingList(pricingList.map(item => item.id === editingPricingId ? newItem : item));
                    setEditingPricingId(null);
                } else {
                    setPricingList([newItem, ...pricingList]);
                }
                
                setPricingForm(initialFormState);
                setIsSaving(false);
            };

            const handleEditPricing = (id) => {
                const item = pricingList.find(p => p.id === id);
                if (!item) return;
                
                setPricingForm({
                    brand: item.brand,
                    targetGm: item.brandTarget || BRAND_TARGETS[item.brand], 
                    category: item.category,
                    articleName: item.articleName,
                    rspWeb: item.rspWeb,
                    hpp: item.hpp,
                    competitorPrice: item.competitorPrice,
                    platformFee: item.platformFee,
                    marketingFee: item.marketingFee,
                    otherFee: item.otherFee || 0, 
                    notes: item.notes || '',
                    manualPrice: item.manualPrice
                });
                setEditingPricingId(id); 
                const formElement = document.querySelector('#pricing-form-container');
                if (formElement) formElement.scrollIntoView({ behavior: 'smooth' });
            };

            const handleCancelEdit = () => {
                setEditingPricingId(null);
                setPricingForm(initialFormState);
            };

            // --- DELETE LOGIC (NEW: With Custom Modal) ---
            
            // 1. Triggered when trash icon is clicked
            const requestDelete = (id) => {
                setDeleteConfirmation(id); // Show the modal
            };

            // 2. Triggered when "Yes, Delete" is clicked in modal
            const confirmDelete = async () => {
                const idToDelete = deleteConfirmation;
                setDeleteConfirmation(null); // Close modal immediately
                setIsSaving(true);

                // Optimistic UI Update (Hapus di layar dulu)
                if (editingPricingId === idToDelete) handleCancelEdit();
                setPricingList(prevList => prevList.filter(item => item.id !== idToDelete));

                // Send delete command to server
                if (GOOGLE_SCRIPT_URL) {
                    setNotification({ type: 'warning', message: 'Menghapus dari cloud...' });
                    try {
                        await sendToGoogleSheet({ action: "delete", id: idToDelete });
                        setNotification({ type: 'success', message: 'Data berhasil dihapus.' });
                    } catch (e) {
                        setNotification({ type: 'error', message: 'Gagal menghapus dari Cloud.' });
                    }
                }
                setIsSaving(false);
            };

            const handleExportPricing = () => {
                if (pricingList.length === 0) return;
                const csvData = pricingList.map(item => {
                    const target = item.brandTarget || BRAND_TARGETS[item.brand] || 0; 
                    const feePct = parseFloat(item.platformFee) + parseFloat(item.marketingFee) + parseFloat(item.otherFee || 0);
                    const feeDec = feePct / 100;
                    const hpp = parseFloat(item.hpp);
                    const mpPrice = parseFloat(item.rspMpSuggest);
                    const floorPriceRaw = hpp / (1 - feeDec - (target/100));
                    
                    let maxDisc = item.maxDiscountSafe;
                    let profAtMax = item.profitAtFloor;

                    if(maxDisc === undefined || profAtMax === undefined) {
                         // Perhitungan Max Disc baru untuk export juga: (RSP MP - RSP Web) / RSP MP
                         if (mpPrice > 0) {
                             maxDisc = ((mpPrice - parseFloat(item.rspWeb)) / mpPrice) * 100;
                         } else {
                             maxDisc = 0;
                         }
                         const feeNominalBaru = parseFloat(item.feeNominalBaru);
                         profAtMax = parseFloat(item.rspWeb) - feeNominalBaru - hpp;
                    }

                    return {
                        "ID": item.id,
                        "Article Name": item.articleName,
                        "Brand": item.brand,
                        "Category": item.category,
                        "RSP Web": item.rspWeb,
                        "Profit Web": item.webGmAbs, 
                        "HPP": item.hpp,
                        "Target GM": `${target}%`, 
                        "RSP MP": item.rspMpSuggest,
                        "Profit MP": item.gmAbsMp, 
                        "GM MP %": item.gmPctMp ? item.gmPctMp.toFixed(2) : 0,
                        "Max Disc %": maxDisc.toFixed(2), 
                        "Profit at Max Disc": profAtMax, 
                        "Date": item.date
                    };
                });
                downloadTableAsCSV(csvData, `Pricing_Export_${new Date().toISOString().slice(0,10)}.csv`);
            };

            // Calculate active competitors for display based on active DB
            const selectedCompetitors = activeCompetitorDB[pricingForm.category] || [];
            const prices = selectedCompetitors.map(c => c.price);
            const minPrice = prices.length ? Math.min(...prices) : 0;
            const maxPrice = prices.length ? Math.max(...prices) : 0;
            const avgPrice = prices.length ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0;
            const minBrand = selectedCompetitors.find(c => c.price === minPrice)?.brand || '-';
            const maxBrand = selectedCompetitors.find(c => c.price === maxPrice)?.brand || '-';

            return (
                <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in relative">
                    
                    {/* CUSTOM DELETE MODAL */}
                    {deleteConfirmation && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 transform transition-all scale-100">
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mb-4 text-rose-600">
                                        <Icons.AlertTriangle size={24} />
                                    </div>
                                    <h3 className="text-lg font-bold text-slate-900 mb-2">Hapus Data Ini?</h3>
                                    <p className="text-sm text-slate-500 mb-6">
                                        Tindakan ini akan menghapus data dari aplikasi dan Google Spreadsheet secara permanen.
                                    </p>
                                    <div className="flex gap-3 w-full">
                                        <button 
                                            onClick={() => setDeleteConfirmation(null)}
                                            className="flex-1 px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 font-bold hover:bg-slate-50 transition-colors"
                                        >
                                            Batal
                                        </button>
                                        <button 
                                            onClick={confirmDelete}
                                            className="flex-1 px-4 py-2 bg-rose-600 rounded-lg text-white font-bold hover:bg-rose-700 shadow-md transition-colors"
                                        >
                                            Ya, Hapus
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TOAST NOTIFICATION */}
                    {notification && (
                        <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-bold text-sm animate-fade-in flex items-center gap-2 ${notification.type === 'success' ? 'bg-emerald-500' : (notification.type === 'error' ? 'bg-rose-500' : 'bg-slate-700')}`}>
                            {notification.type === 'success' && <Icons.Cloud size={18}/>}
                            {notification.message}
                        </div>
                    )}

                    {/* Header */}
                    <div className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 pb-6">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md tracking-tight">
                                <Icons.Tag size={24} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight text-slate-900">Pricing Calculator</h1>
                                <p className="text-sm text-slate-500 font-medium">Margin Analysis & Competitor Benchmarking</p>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            {!GOOGLE_SCRIPT_URL && (
                                <div className="text-xs text-amber-600 bg-amber-50 px-3 py-1.5 rounded-md border border-amber-200 font-bold hidden sm:block">
                                    Offline Mode (No Sheet URL)
                                </div>
                            )}
                            <div className="flex gap-2 text-sm text-slate-500 bg-slate-100 px-4 py-2 rounded-lg">
                                <span className="font-semibold text-slate-700">Database:</span> {pricingList.length} items saved
                            </div>
                        </div>
                    </div>

                    <div className="space-y-8">
                        {/* FORM & CALCULATOR SECTION */}
                        <div id="pricing-form-container" className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <Icons.Tag className="text-indigo-600" size={20}/>
                                    <h3 className="font-bold text-slate-800">{editingPricingId ? 'Edit Pricing Item' : 'New Pricing Calculation'}</h3>
                                </div>
                            </div>
                            
                            <div className="p-8">
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                    {/* LEFT: INPUTS */}
                                    <div className="space-y-5">
                                        <div className="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100 space-y-4">
                                            <h4 className="text-xs font-bold text-indigo-700 uppercase tracking-wider mb-2">Basic Info</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-700 mb-1.5">Brand</label>
                                                    <select className="w-full p-2.5 border border-slate-300 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" value={pricingForm.brand} onChange={handleBrandChange}>
                                                        {Object.keys(BRAND_TARGETS).map(b => <option key={b} value={b}>{b}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-700 mb-1.5">Target GM (%)</label>
                                                    <input 
                                                        type="number" 
                                                        className="w-full p-2.5 border border-slate-300 rounded-lg bg-white text-slate-800 font-bold text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                        value={pricingForm.targetGm}
                                                        onChange={handleTargetGmChange}
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-700 mb-1.5">Product Category</label>
                                                <select className="w-full p-2.5 border border-slate-300 rounded-lg bg-white text-sm focus:ring-2 focus:ring-indigo-500 outline-none" value={pricingForm.category} onChange={handleCategoryChange}>
                                                    <option value="">-- Select Category --</option>
                                                    {Object.keys(activeCompetitorDB).map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-700 mb-1.5">Article Name</label>
                                                <input type="text" className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Tunic Raya Series A" value={pricingForm.articleName} onChange={(e) => setPricingForm({...pricingForm, articleName: e.target.value})} />
                                            </div>
                                        </div>

                                        {/* Competitor Insight Panel */}
                                        {selectedCompetitors.length > 0 && (
                                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 text-xs space-y-3 shadow-inner">
                                                <div className="font-bold text-slate-600 uppercase tracking-wide border-b border-slate-200 pb-2 mb-1 flex justify-between">
                                                    <span>Marketplace Insight ({pricingForm.category})</span>
                                                    <span className="text-slate-400">{selectedCompetitors.length} Data</span>
                                                </div>
                                                <div className="grid grid-cols-3 gap-3 text-center">
                                                    <div className="bg-white p-2.5 rounded border border-emerald-100 shadow-sm">
                                                        <div className="text-slate-400 text-[10px] uppercase font-bold">Lowest</div>
                                                        <div className="font-bold text-emerald-600 text-sm mt-1">{formatRupiah(minPrice)}</div>
                                                        <div className="text-[9px] text-slate-500 truncate mt-0.5">{minBrand}</div>
                                                    </div>
                                                    <div className="bg-white p-2.5 rounded border border-blue-100 shadow-sm">
                                                        <div className="text-slate-400 text-[10px] uppercase font-bold">Average</div>
                                                        <div className="font-bold text-blue-600 text-sm mt-1">{formatRupiah(avgPrice)}</div>
                                                        <div className="text-[9px] text-slate-500 mt-0.5">Market Avg</div>
                                                    </div>
                                                    <div className="bg-white p-2.5 rounded border border-rose-100 shadow-sm">
                                                        <div className="text-slate-400 text-[10px] uppercase font-bold">Highest</div>
                                                        <div className="font-bold text-rose-600 text-sm mt-1">{formatRupiah(maxPrice)}</div>
                                                        <div className="text-[9px] text-slate-500 truncate mt-0.5">{maxBrand}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}

                                        <div className="bg-white p-4 rounded-lg border border-slate-200 space-y-4">
                                            <h4 className="text-xs font-bold text-slate-700 uppercase tracking-wider mb-2">Cost & Fees</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-700 mb-1.5 flex justify-between">
                                                        RSP Web (IDR)
                                                        {pricingForm.brand === 'HEYMALE' && <span className="text-[10px] text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full font-bold animate-pulse">AUTO CALCULATED</span>}
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        className={`w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${pricingForm.brand === 'HEYMALE' ? 'bg-indigo-50 text-indigo-800 font-bold border-indigo-200 cursor-not-allowed' : ''}`}
                                                        value={pricingForm.rspWeb} 
                                                        onChange={(e) => setPricingForm({...pricingForm, rspWeb: e.target.value})} 
                                                        placeholder="0"
                                                        readOnly={pricingForm.brand === 'HEYMALE'}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-700 mb-1.5">HPP (IDR)</label>
                                                    <input 
                                                        type="number" 
                                                        className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={pricingForm.hpp} 
                                                        onChange={handleHppChange} 
                                                        placeholder="Input HPP here..." 
                                                    />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-3">
                                                <div><label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Platform %</label><input type="number" className="w-full p-2 border border-slate-300 rounded text-sm text-center" value={pricingForm.platformFee} onChange={(e) => setPricingForm({...pricingForm, platformFee: e.target.value})} /></div>
                                                <div><label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Marketing %</label><input type="number" className="w-full p-2 border border-slate-300 rounded text-sm text-center" value={pricingForm.marketingFee} onChange={(e) => setPricingForm({...pricingForm, marketingFee: e.target.value})} /></div>
                                                <div><label className="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Other %</label><input type="number" className="w-full p-2 border border-slate-300 rounded text-sm text-center" placeholder="0" value={pricingForm.otherFee} onChange={(e) => setPricingForm({...pricingForm, otherFee: e.target.value})} /></div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* RIGHT: ANALYSIS & RESULTS */}
                                    <div className="flex flex-col justify-between bg-slate-50 p-6 rounded-xl border border-slate-200 shadow-inner h-full">
                                        <div>
                                            <h4 className="text-sm font-bold text-slate-800 uppercase tracking-wider mb-5 flex items-center gap-2"><Icons.Lightbulb size={18} className="text-amber-500"/> Pricing Breakdown</h4>
                                            <div className="space-y-4 text-sm">
                                                <div className="flex justify-between items-center pb-2 border-b border-slate-200">
                                                    <span className="text-slate-600 font-medium">Web GM% <span className="text-xs text-slate-400 font-normal">(Target: {pricingResult.brandTarget}%)</span></span>
                                                    <div className="text-right">
                                                        <span className={`font-bold px-2 py-1 rounded text-xs ${pricingResult.webGmPct >= pricingResult.brandTarget ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>{Number(pricingResult.webGmPct || 0).toFixed(2)}%</span>
                                                        <div className="text-[10px] text-slate-400 mt-0.5">{formatRupiah(pricingResult.webGmAbs)}</div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex flex-col gap-3 bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-indigo-700 font-bold text-xs uppercase">RSP Ideal (Cost Plus)</span>
                                                        <span className="text-sm font-mono text-indigo-900 font-bold">{formatRupiah(pricingResult.rspBaru)}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center text-xs border-t border-slate-100 pt-2">
                                                        <span className="text-slate-500">Locked Fee Nominal</span>
                                                        <span className="text-slate-700 font-medium">{formatRupiah(pricingResult.feeNominalBaru)}</span>
                                                    </div>
                                                </div>

                                                <div className="mb-4">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">3. Competitor Comparison (IDR)</label>
                                                    <input type="number" className="w-full p-2.5 text-sm border border-slate-300 rounded-lg bg-white mb-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter Competitor Price..." value={pricingForm.competitorPrice} onChange={(e) => setPricingForm({...pricingForm, competitorPrice: e.target.value})} />
                                                    
                                                    {/* SYSTEM RECOMMENDATION BLOCK */}
                                                    <div className={`p-4 rounded-lg border text-xs space-y-3 transition-colors duration-300 ${pricingResult.recommendation.status === 'good' ? 'bg-emerald-50 border-emerald-200' : (pricingResult.recommendation.status === 'warning' ? 'bg-amber-50 border-amber-200' : 'bg-white border-slate-200')}`}>
                                                        <div className="flex gap-3">
                                                            <div className="w-full">
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="font-bold text-xs text-slate-500 mb-1 uppercase tracking-wide">System Suggestion</div>
                                                                        <div className="text-3xl font-bold text-indigo-700 tracking-tight">{formatRupiah(pricingResult.recommendation.price)}</div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className={`text-[10px] font-bold px-2 py-0.5 rounded-full inline-block ${pricingResult.recommendation.gmPct >= pricingResult.brandTarget ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>
                                                                            GM: {pricingResult.recommendation.gmPct.toFixed(2)}%
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div className="mt-3 mb-2 text-slate-700 leading-relaxed whitespace-pre-line font-medium text-[11px] border-l-2 border-indigo-300 pl-3">
                                                                    {pricingResult.recommendation.reason}
                                                                </div>

                                                                <div className="flex justify-between items-center mt-3 pt-3 border-t border-black/5">
                                                                    <div>
                                                                        <span className="block text-[10px] text-slate-500 uppercase font-bold">Max Disc Aman</span>
                                                                        <span className="text-sm font-bold text-slate-700">{pricingResult.recommendation.maxDiscount.toFixed(1)}%</span>
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => setPricingForm({...pricingForm, manualPrice: pricingResult.recommendation.price})}
                                                                        className="bg-indigo-600 text-white px-3 py-1.5 rounded shadow-sm hover:bg-indigo-700 font-bold text-xs transition-colors"
                                                                    >
                                                                        Apply Price
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="bg-slate-800 p-4 rounded-lg text-white">
                                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Final Manual Price</label>
                                                    <input type="number" className="w-full p-2 border border-slate-600 rounded bg-slate-700 text-white font-bold text-lg focus:ring-2 focus:ring-indigo-500 outline-none mb-3" placeholder={pricingResult.rspBaru} value={pricingForm.manualPrice} onChange={(e) => setPricingForm({...pricingForm, manualPrice: e.target.value})} />
                                                    
                                                    <div className="space-y-1 text-xs">
                                                        <div className="flex justify-between"><span className="text-slate-400">Total Fee Deduction</span><span className="text-rose-400">-{formatRupiah(pricingResult.rspMpSuggest * (parseFloat(pricingForm.platformFee)+parseFloat(pricingForm.marketingFee)+parseFloat(pricingForm.otherFee || 0))/100)}</span></div>
                                                        <div className="flex justify-between pt-2 border-t border-slate-600 mt-2"><span className="text-slate-300 font-bold">Net Profit (GM Abs)</span><span className="font-bold text-emerald-400">{formatRupiah(pricingResult.gmAbsMp)}</span></div>
                                                        <div className="flex justify-between"><span className="text-slate-300 font-bold">Net Margin (GM %)</span><span className="font-bold text-emerald-400">{Number(pricingResult.gmPctMp || 0).toFixed(2)}%</span></div>
                                                        
                                                        {/* Live Max Disc Calc in Panel */}
                                                        <div className="flex justify-between pt-2 mt-2 border-t border-slate-600">
                                                            <span className="text-amber-400 font-bold">Max Safe Disc</span>
                                                            <span className="font-bold text-amber-400">{pricingResult.maxDiscountSafe.toFixed(1)}%</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-400 italic">Profit at Max Disc</span>
                                                            <span className="font-medium text-slate-400">{formatRupiah(pricingResult.profitAtFloor)}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-3 mt-6">
                                            {editingPricingId && (
                                                <button onClick={handleCancelEdit} disabled={isSaving} className="w-1/3 bg-white border border-slate-300 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-50 transition-colors disabled:opacity-50">Cancel</button>
                                            )}
                                            <button onClick={handleSavePricing} disabled={!pricingForm.articleName || isSaving} className={`flex-1 text-white py-3 rounded-lg font-bold shadow-md transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${editingPricingId ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-900 hover:bg-slate-800'}`}>
                                                {isSaving ? (
                                                    <><span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> Saving...</>
                                                ) : (
                                                    <>{editingPricingId ? 'Update Price Record' : 'Save to List'}</>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* SAVED RECORDS TABLE */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <Icons.List className="text-slate-500" size={20}/>
                                    <h3 className="font-bold text-slate-800">Saved Records</h3>
                                </div>
                                <button onClick={handleExportPricing} className="px-3 py-1.5 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 flex items-center gap-1 text-xs font-bold transition-colors shadow-sm"><Icons.Download size={14}/> Export CSV</button>
                            </div>
                            {pricingList.length === 0 ? (
                                <div className="p-12 text-center flex flex-col items-center justify-center text-slate-400">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300">
                                        <Icons.Tag size={32}/>
                                    </div>
                                    <p>No pricing records saved yet.</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left min-w-[1500px]">
                                        <thead className="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 text-xs uppercase tracking-wider">
                                            <tr>
                                                <th className="px-4 py-3 text-center w-[100px]">Brand</th>
                                                <th className="px-4 py-3 text-left">Article</th>
                                                <th className="px-4 py-3 text-right">RSP Web</th>
                                                <th className="px-4 py-3 text-right text-emerald-600 bg-emerald-50/50">Profit Web</th>
                                                <th className="px-4 py-3 text-right text-slate-400">HPP</th>
                                                <th className="px-4 py-3 text-right bg-indigo-50/50 text-indigo-900 border-l border-indigo-100">Final MP</th>
                                                <th className="px-4 py-3 text-right bg-indigo-50/50 text-indigo-900">Profit MP</th>
                                                <th className="px-4 py-3 text-center bg-indigo-50/50 text-indigo-900">GM MP</th>
                                                <th className="px-4 py-3 text-center bg-amber-50/50 text-amber-800 border-l border-amber-100">Max Disc</th>
                                                <th className="px-4 py-3 text-right bg-amber-50/50 text-amber-800">Profit Max Disc</th>
                                                <th className="px-4 py-3 text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {pricingList.map(item => {
                                                const target = item.brandTarget || BRAND_TARGETS[item.brand] || 0;
                                                const feePct = parseFloat(item.platformFee) + parseFloat(item.marketingFee) + parseFloat(item.otherFee || 0);
                                                const feeDec = feePct / 100;
                                                const hpp = parseFloat(item.hpp);
                                                const mpPrice = parseFloat(item.rspMpSuggest);
                                                const floorPriceRaw = hpp / (1 - feeDec - (target/100));
                                                
                                                let maxDisc = item.maxDiscountSafe;
                                                let profAtMax = item.profitAtFloor;
                                                
                                                if (maxDisc === undefined || profAtMax === undefined) {
                                                    maxDisc = mpPrice > floorPriceRaw ? ((mpPrice - floorPriceRaw) / mpPrice * 100) : 0;
                                                    const feeAtFloor = floorPriceRaw * feeDec;
                                                    profAtMax = floorPriceRaw - feeAtFloor - hpp;
                                                }

                                                return (
                                                <tr key={item.id} className={`hover:bg-slate-50 transition-colors ${editingPricingId === item.id ? 'bg-indigo-50 hover:bg-indigo-50 border-l-4 border-indigo-500' : ''}`}>
                                                    <td className="px-4 py-3 text-center font-bold text-slate-600 text-xs">{item.brand}</td>
                                                    <td className="px-4 py-3">
                                                        <div className="font-medium text-slate-800">{item.articleName}</div>
                                                        <div className="text-[10px] text-slate-500">{item.category}</div>
                                                    </td>
                                                    <td className="px-4 py-3 text-right font-medium text-slate-700">{formatRupiah(item.rspWeb)}</td>
                                                    <td className="px-4 py-3 text-right font-bold text-emerald-600 bg-emerald-50/30">{formatRupiah(item.webGmAbs)}</td>
                                                    <td className="px-4 py-3 text-right text-slate-400">{formatRupiah(item.hpp)}</td>
                                                    <td className="px-4 py-3 text-right bg-indigo-50/30 border-l border-indigo-50">
                                                        <div className="font-bold text-indigo-700">{formatRupiah(item.rspMpSuggest)}</div>
                                                    </td>
                                                    <td className="px-4 py-3 text-right bg-indigo-50/30 font-bold text-indigo-600">
                                                        {formatRupiah(item.gmAbsMp)}
                                                    </td>
                                                    <td className="px-4 py-3 text-center bg-indigo-50/30">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold ${item.gmPctMp >= target ? 'text-emerald-700 bg-emerald-100' : 'text-rose-700 bg-rose-100'}`}>
                                                            {Number(item.gmPctMp || 0).toFixed(1)}%
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-3 text-center bg-amber-50/30 border-l border-amber-50">
                                                        <div className="font-bold text-amber-700">{maxDisc.toFixed(1)}%</div>
                                                    </td>
                                                    <td className="px-4 py-3 text-right bg-amber-50/30 text-amber-800 font-medium">
                                                        {formatRupiah(profAtMax)}
                                                    </td>
                                                    <td className="px-4 py-3 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <button onClick={() => handleEditPricing(item.id)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Edit"><Icons.Edit size={16}/></button>
                                                            <button onClick={() => requestDelete(item.id)} className="p-1.5 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded transition-colors" title="Delete"><Icons.Trash2 size={16}/></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )})} 
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
